<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase_version9_RealtimeDB(G'sACADEMYåˆå­¦è€…ç”¨ã‚µãƒ³ãƒ—ãƒ«)</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
</head>

<body>

    <h1>å˜èªãƒ¡ãƒ¢</h1>
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
    <div>
        <!-- å„å ´æ‰€ã«idã‚’è¨­å®šã—ã¾ã—ã‚‡ã† -->
        <div>
            <input id="uname" type="text" name="uname" placeholder="ãƒ•ãƒ©ãƒ³ã‚¹èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        </div>

       
        <button id="btn_yomu">ç™ºéŸ³</button>
        <button id="btn_honyaku">ç¿»è¨³</button>

        <div>
            <textarea id="text" placeholder="æ—¥æœ¬èªè¨³"></textarea>
        </div>
        <button id="send">ç™»éŒ²ã™ã‚‹</button>
        <!-- style.cssã« "overflow: auto;"ã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ï¼â€»æœ€å¾Œã« -->
        <div id="output"></div>

    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getDatabase, ref, push, set, update, onChildAdded, onChildChanged, remove, onChildRemoved }
            from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";


        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); //RealtimeDBã«æ¥ç¶š
        const dbRef = ref(db, "chat"); //RealtimeDBå†…ã®"chat"ã‚’ä½¿ã†

        
        // ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
        $("#btn_yomu").click( function () {
            const text = document.getElementById("uname").value;
                 console.log(text,'æœ€åˆã®ç™ºéŸ³');
                if ('speechSynthesis' in window) {  
                    // ç™ºè¨€ã‚’è¨­å®š
                    const uttr = new SpeechSynthesisUtterance()
                    uttr.text = text
                    // è¨€èªã‚’è¨­å®š
                    uttr.lang = 'fr'

                    // ä»èªã«å¯¾å¿œã—ã¦ã„ã‚‹voiceã‚’è¨­å®š
                    // const voices = speechSynthesis.getVoices()
                    // console.log(voices,'å‡ºã‚‹éŸ³')
                    //     for (let i = 0; i < voices.length; i++) {
                    //         if (voices[i].lang === 'fr') {
                    //             uttr.voice = voices[i]
                    //         };
                    //     };
                        // ç™ºè¨€ã‚’å†ç”Ÿ
                        window.speechSynthesis.speak(uttr)
                    }; 
            });

        // ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
        $("#btn_honyaku").click( function () {

            const API_KEY = '' ;
            const API_URL = '';
            
            const entext = document.getElementById("uname").value;
                //console.log(entext);
                let content = encodeURI('auth_key=' + API_KEY + '&text=' + entext + '&source_lang=FR&target_lang=JA');
                let url = API_URL + '?' + content;

            fetch(url)
                 .then(function(response) {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("Could not reach the API: " + response.statusText);
                     }
                }).then(function(data) {
                     document.getElementById("text").value = data["translations"][0]["text"];
                 }).catch(function(error) {
                    document.getElementById("text").value = error.message;
                });           
        });



        // function readAloud() {
        //     // ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        //     const text = document.getElementById("text").value;
        //     console.log(text);
        //         if ('speechSynthesis' in window) {
        //             // ç™ºè¨€ã‚’è¨­å®š
        //             const uttr = new SpeechSynthesisUtterance()
        //             uttr.text = text
        //             // ç™ºè¨€ã‚’å†ç”Ÿ
        //             window.speechSynthesis.speak(uttr)
        //         }; 
        //     };


        //ãƒ‡ãƒ¼ã‚¿ç™»éŒ²(Click)
            $('#send').on('click', function () {
            const uname = $('#uname').val();
            const text = $('#text').val();
            
            // const msg = {
            //     uname : $('#uname').val(),
            //     const : $('#text').val()
            // }

            const msg = {
                uname: uname,
                text: text,
            }

             //firebaseã«
            const newPostRef = push(dbRef);
            set(newPostRef, msg);

            $('#uname').val("");
            $('#text').val("");

            // ã“ã®ä¸‹ã¯æ¶ˆã•ãªã„
        });
        

        //ãƒ‡ãƒ¼ã‚¿ç™»éŒ²(Enter)

        //æœ€åˆã«ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

        onChildAdded(dbRef, function (data) {
            const msg = data.val();
            const key = data.key;
            //console.log(msg,"å¡Š");
            //console.log(key,"éµ");
            
            // let html = `
            //     <div class=${key}>
            //         <p>${msg.uname}</p>
            //         <p>${msg.text}</p>
            //     </div>  
            // `

            let h = '<div id="'+key+'">';
                h += '<p id="'+key+'_sound" class="uname">'+msg.uname+'</p>';
                h += '<p contentEditable="true" id="'+key+'_update">'+msg.text+'</p>';
                h += '<p class="sound" data-key="'+key+'">ğŸ”ˆ</p>';
                h += '<p class="remove" data-key="'+key+'">ğŸš®</p>';
                h += '<p class="update" data-key="'+key+'">ğŸ†™</p>';
                h += '</div>';

            // ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã«åŸ‹ã‚è¾¼ã¿ã¾ã™
            //$('#output').append(html)
            $('#output').prepend(h);

        });

        //å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#output").on("click", ".remove", function(){
            const key = $(this).attr("data-key");
            const remove_item = ref(db, "chat/"+key);
            remove (remove_item);
        });
        //å‰Šé™¤å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
        onChildRemoved(dbRef, (data) => {
            $("#"+data.key).remove();
        });

        //æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#output").on("click", ".update", function(){
            const key = $(this).attr("data-key");
            update(ref(db, "chat/"+key), {
                text : $("#"+key+'_update').html()
            });
        });

        //æ›´æ–°å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
        onChildChanged(dbRef, (data) => {
            $("#"+data.key+'_update').html(data.val().text);
            $("#"+data.key+'_update').fadeOut(800).fadeIn(800);
        });

        //ç™ºéŸ³ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#output").on("click", ".sound", function(){
           // const text = document.getElementById("uname").value;
            const key = $(this).attr("data-key");
            const sound = $("#"+key+'_sound').html();
            //console.log(sound,'æ¬¡ã®ç™ºéŸ³');
            if ('speechSynthesis' in window) {  
                    // ç™ºè¨€ã‚’è¨­å®š
                    const uttr2 = new SpeechSynthesisUtterance(sound)
                    uttr2.sound = sound
                    //console.log(uttr2.sound, "æœ€å¾Œ")
                    // è¨€èªã‚’è¨­å®š
                    uttr2.lang = 'fr'

                    // ä»èªã«å¯¾å¿œã—ã¦ã„ã‚‹voiceã‚’è¨­å®š
                    // const voices2 = speechSynthesis.getVoices()
                    //     for (let i = 0; i < voices2.length; i++) {
                    //         if (voices2[i].lang === 'fr') {
                    //             uttr.voice2 = voices2[i]
                    //         };
                    //     };
                    //     console.log(uttr.voices2,'å‡ºãªã„éŸ³')
                        // ç™ºè¨€ã‚’å†ç”Ÿ
                        window.speechSynthesis.speak(uttr2)
                    };
                    
        });

    </script>
</body>

</html>